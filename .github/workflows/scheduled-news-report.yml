name: Scheduled RSS News Report

on:
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *'
    - cron: '0 2 * * 1'

permissions:
  contents: read
  issues: write

jobs:
  generate-report:
    environment: prod
    runs-on: ubuntu-latest
    env:
      # Support both OPENAI_KEY and the more common OPENAI_API_KEY.
      OPENAI_KEY: ${{ secrets.OPENAI_KEY || secrets.OPENAI_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || secrets.OPENAI_KEY }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      WORK_BACKGROUND: ${{ vars.WORK_BACKGROUND }}
      SOURCE_DIR: ${{ vars.SOURCE_DIR }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate required env
        run: |
          set -euo pipefail
          missing=0
          for v in OPENAI_KEY OPENAI_MODEL; do
            if [ -z "${!v:-}" ]; then
              echo "::error::$v is empty. Add it in Settings -> Secrets and variables -> Actions -> Secrets."
              missing=1
            fi
          done
          # OPENAI_BASE_URL is optional in code (defaults to https://api.openai.com/v1), but if you target
          # a non-OpenAI compatible vendor, you should set it explicitly.
          if [ "$missing" -ne 0 ]; then exit 1; fi

      - name: Generate report
        run: |
          DIR="${SOURCE_DIR:-rss-source}"
          npm start -- --source-dir "$DIR"

      - name: Upload reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: news-reports-${{ github.run_id }}
          path: news/*
          if-no-files-found: error

      - name: Publish report as issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const newsDir = path.join(process.env.GITHUB_WORKSPACE, 'news');
            const files = fs.readdirSync(newsDir).filter((f) => f.endsWith('.md')).sort();
            if (files.length === 0) {
              core.setFailed('No markdown report found in news/');
              return;
            }

            const latest = files[files.length - 1];
            const body = fs.readFileSync(path.join(newsDir, latest), 'utf8');
            const title = `[RSSAgent] ${latest.replace('.md', '')}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['report', 'automation'],
            });
